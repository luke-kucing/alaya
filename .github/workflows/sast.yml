name: SAST (Semgrep)

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  schedule:
    # Weekly scan on Monday at 08:00 UTC
    - cron: "0 8 * * 1"

jobs:
  semgrep:
    name: Semgrep scan
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    # Skip on PRs from forks to avoid secret exposure
    if: github.actor != 'dependabot[bot]'

    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep (OSS rules)
        run: |
          semgrep scan \
            --config p/default \
            --config p/python \
            --config p/owasp-top-ten \
            --config p/security-audit \
            --config p/secrets \
            --config .semgrep/ \
            --sarif-output semgrep.sarif \
            --json-output semgrep.json \
            src/
        # To publish results to semgrep.dev, add SEMGREP_APP_TOKEN to repo secrets

      - name: Fail on ERROR-level findings
        run: |
          count=$(python3 -c "
          import json, sys
          data = json.load(open('semgrep.json'))
          errors = [r for r in data.get('results', []) if r.get('extra', {}).get('severity') == 'ERROR']
          print(len(errors))
          ")
          if [ "$count" -gt 0 ]; then
            echo "::error::Semgrep found $count ERROR-level finding(s)"
            exit 1
          fi

      - name: Upload SARIF to GitHub Code Scanning
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        continue-on-error: true  # SARIF upload requires Code Scanning to be enabled
